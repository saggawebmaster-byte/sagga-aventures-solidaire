# Syst√®me d'Emails SAGGA - Documentation

## üéØ Vue d'ensemble

Le syst√®me d'emails SAGGA permet d'envoyer automatiquement des notifications par email lorsqu'une demande d'aide sociale est soumise. Le syst√®me route les emails vers diff√©rents destinataires selon :

1. **Type de demande** : Normale ou AAU (Aide Alimentaire d'Urgence)
2. **Ville du demandeur** : D√©termine l'organisation destinataire

## üìß Workflow des emails

### Demandes normales (AAU non coch√©)
- **Destinataires** : √âpiceries/Structures par ville
- **Objectif** : Traitement standard des demandes d'aide alimentaire
- **D√©lai** : Traitement dans les d√©lais habituels

### Demandes AAU (AAU coch√©) 
- **Destinataires** : CCAS (Centre Communal d'Action Sociale) par ville
- **Copies** : contact@sagga.fr et administratif@sagga.fr
- **Objectif** : Traitement urgent des situations de pr√©carit√© alimentaire
- **D√©lai** : Traitement prioritaire

## üèóÔ∏è Architecture technique

### Fichiers principaux

1. **`lib/email-config.ts`** : Configuration des destinataires et messages
2. **`lib/email-service.ts`** : Service d'envoi avec Resend
3. **`app/api/demandes/route.ts`** : Int√©gration dans l'API

### Service utilis√©
- **Resend** : Service d'envoi d'emails transactionnel
- **Templates HTML** : Emails format√©s avec toutes les informations de la demande

## üìç Destinataires configur√©s

### √âpiceries (Demandes normales)
| Ville | Email | Nom |
|-------|-------|-----|
| CAYENNE | epicerie.cayenne@sagga.fr | Epicerie TI DEGRA |
| SAINT-LAURENT DU MARONI | epicerie.sl@sagga.fr | Epicerie TI BAKISCI |
| MACOURIA | epicerie.macouria@sagga.fr | Epicerie TI KEKE |

### CCAS (Demandes AAU)
| Ville | Email | Nom | Code |
|-------|-------|-----|------|
| CAYENNE | ccas.cayenne@sagga.fr | CCAS CAYENNE | 688192 |
| MACOURIA | ccas.macouria@sagga.fr | CCAS MACOURIA | 688547 |
| REMIRE-MONTJOLY | ccas.rm@sagga.fr | CCAS REMIRE-MONTJOLY | 688201 |
| MATOURY | ccas.matoury@sagga.fr | CCAS MATOURY | 688204 |
| ROURA | ccas.roura@sagga.fr | CCAS ROURA | 688206 |
| KOUROU | ccas.kouru@sagga.fr | CCAS KOUROU | 688612 |
| MONTSINERY-TONNEGRANDE | ccas.montsinery@sagga.fr | CCAS MONTSINERY | 688212 |
| SAINT-LAURENT DU MARONI | ccas.sl@sagga.fr | CCAS SAINT LAURENT | 762402 |
| MANA | ccas.mana@sagga.fr | CCAS MANA | 762316 |
| IRACOUBO | ccas.iracoubou@sagga.fr | CCAS IRACOUBO | 688197 |

## üé® Template d'email

### Contenu inclus
- **Header SAGGA** : Avec badge d'urgence pour AAU
- **Message personnalis√©** : Diff√©rent selon le type de demande
- **Informations personnelles** : Nom, pr√©nom, contact, etc.
- **Adresse de r√©sidence** : Ville mise en √©vidence
- **Section AAU** : Visible uniquement pour les demandes urgentes
- **Composition du foyer** : Membres de la famille
- **Commentaires** : Informations compl√©mentaires
- **Documents joints** : Nombre de fichiers upload√©s

### Design
- **Responsive** : Optimis√© mobile et desktop
- **Couleurs th√©matiques** : Violet SAGGA, rouge pour urgence
- **Ic√¥nes** : Visuels pour chaque section
- **Lisibilit√©** : Police syst√®me, contrastes √©lev√©s

## üöÄ Utilisation

### Envoi automatique
Les emails sont envoy√©s automatiquement apr√®s :
1. ‚úÖ Validation des donn√©es du formulaire
2. ‚úÖ Cr√©ation r√©ussie de la demande en base
3. üìß Envoi de l'email de notification

### Gestion des erreurs
- Les erreurs d'email n'emp√™chent **pas** la cr√©ation de la demande
- Les erreurs sont logg√©es pour debugging
- L'utilisateur re√ßoit confirmation m√™me si l'email √©choue

## ‚öôÔ∏è Configuration

### Variables d'environnement
```bash
# .env.local
RESEND_API_KEY="re_your_api_key_here"
```

### Obtenir une cl√© API Resend
1. Cr√©er un compte sur [resend.com](https://resend.com)
2. Aller dans le dashboard API Keys
3. Cr√©er une nouvelle cl√© API
4. Copier dans `.env.local`

## üß™ Tests

### Test de configuration
```bash
node scripts/test-email-config.js
```

### Test via le formulaire
1. D√©marrer le serveur : `npm run dev`
2. Aller sur `/demande`
3. Remplir le formulaire avec/sans AAU
4. Soumettre et v√©rifier les logs

## üìã Messages types

### √âpiceries (demandes normales)
```
Bonjour, 
Une nouvelle demande d'aide alimentaire a √©t√© d√©pos√©e et n√©cessite votre examen. 
Merci de la traiter dans les plus brefs d√©lais.
```

### CCAS (demandes AAU)
```
Bonjour,
Une requ√™te pour une aide alimentaire d'urgence a √©t√© d√©pos√©e. 
Nous vous remercions de proc√©der √† son instruction et de nous faire part de votre d√©cision aux adresses mails suivantes : 
‚Ä¢ contact@sagga.fr 
‚Ä¢ administratif@sagga.fr
```

## üîß Maintenance

### Ajouter une nouvelle ville
1. Modifier `lib/email-config.ts`
2. Ajouter dans `EPICERIE_EMAIL_MAP` et/ou `CCAS_EMAIL_MAP`
3. Tester avec le script de configuration

### Modifier les templates
1. √âditer `generateEmailTemplate()` dans `lib/email-service.ts`
2. Tester le rendu HTML
3. V√©rifier la responsivit√©

### Changer les messages
1. Modifier `EMAIL_MESSAGES` dans `lib/email-config.ts`
2. Tester avec les deux types de demandes

## üö® D√©pannage

### Email non envoy√©
1. V√©rifier `RESEND_API_KEY` dans `.env.local`
2. Contr√¥ler les logs de l'API : `/api/demandes`
3. V√©rifier que la ville est support√©e
4. Tester la configuration avec le script

### Destinataire incorrect
1. V√©rifier la normalisation des noms de villes
2. Contr√¥ler `getDestinationEmail()` dans la config
3. S'assurer que la ville exact est dans les maps

### Template cass√©
1. V√©rifier la syntaxe HTML dans `generateEmailTemplate()`
2. Tester avec des donn√©es simples
3. Contr√¥ler les caract√®res sp√©ciaux dans les donn√©es
